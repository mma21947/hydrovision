{% extends "ordens/base_ordens.html" %}

{% block title %}Nova Ordem de Serviço - HydrovisionOS{% endblock %}

{% block extra_css %}

<style>
    .form-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        border: none;
        transition: all 0.3s ease;
    }
    
    .form-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    
    .form-section {
        padding: 2rem;
        border-radius: 10px;
        background-color: white;
        margin-bottom: 1.5rem;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.25rem;
    }
    
    .cliente-icon { background: linear-gradient(135deg, #4158D0, #C850C0); }
    .servico-icon { background: linear-gradient(135deg, #43C6AC, #191654); }
    .local-icon { background: linear-gradient(135deg, #0093E9, #80D0C7); }
    .valores-icon { background: linear-gradient(135deg, #FFCC70, #C850C0); }
    
    .fade-in-section {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.5s ease forwards;
    }
    
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .fade-in-section:nth-child(1) { animation-delay: 0.1s; }
    .fade-in-section:nth-child(2) { animation-delay: 0.2s; }
    .fade-in-section:nth-child(3) { animation-delay: 0.3s; }
    .fade-in-section:nth-child(4) { animation-delay: 0.4s; }
    
    .form-floating {
        margin-bottom: 1rem;
    }
    
    .form-floating > label {
        padding-left: 1rem;
    }
    
    .form-control {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    
    .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }
    
    /* Estilos para campos de localização */
    .localizacao-field.loading-data {
        background-color: #f8f9fa;
        animation: pulse 1.5s infinite ease-in-out;
    }
    
    .localizacao-field.auto-filled {
        background-color: rgba(40, 167, 69, 0.1);
        border-color: #28a745;
        transition: all 0.3s ease;
    }
    
    @keyframes pulse {
        0% { background-color: #f8f9fa; }
        50% { background-color: #e9ecef; }
        100% { background-color: #f8f9fa; }
    }
    
    .field-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .btn-action {
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #2980b9, #3498db);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .btn-outline-secondary {
        border: 1px solid #6c757d;
        color: #6c757d;
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
        transform: translateY(-3px);
    }
    
    .prioridade-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 1rem;
    }
    
    .prioridade-option {
        flex: 1;
        border-radius: 10px;
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .prioridade-option:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .prioridade-option.selected {
        border-width: 2px;
    }
    
    .prioridade-baixa {
        border-color: #3498db;
        color: #3498db;
    }
    
    .prioridade-baixa.selected {
        background-color: #3498dba2;
        color: white;
    }
    
    .prioridade-media {
        border-color: #f39c12;
        color: #f39c12;
    }
    
    .prioridade-media.selected {
        background-color: #f39d129d;
        color: white;
    }
    
    .prioridade-alta {
        border-color: #e67e22;
        color: #e67e22;
    }
    
    .prioridade-alta.selected {
        background-color: #e67d22a8;
        color: white;
    }
    
    .prioridade-urgente {
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .prioridade-urgente.selected {
        background-color: #e74d3ca9;
        color: white;
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .cliente-card {
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        padding: 15px;
        margin-top: 15px;
        display: none;
    }
    
    .cliente-card.show {
        display: block;
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .cliente-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #3498db;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .usar-endereco-cliente {
        cursor: pointer;
        color: var(--secondary-color);
        text-decoration: underline;
        font-weight: 500;
    }
    
    .usar-endereco-cliente:hover {
        color: #2980b9;
    }
    
    .checkbox-toggle {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .form-check-input {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
    }
    
    #status-badge {
        font-size: 0.8rem;
        padding: 0.25em 0.6em;
        font-weight: 500;
        border-radius: 50px;
        background-color: #3498db;
        color: white;
        display: inline-block;
        margin-left: 15px;
    }
    
    .input-group .btn {
        padding: 0.375rem 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 42px;
    }
    
    .input-group .btn-outline-secondary + .btn-outline-secondary {
        margin-left: -1px;
    }
    
    /* Estilos específicos para os links de equipamento */
    #botoes-equipamento {
        display: flex;
    }
    
    #botoes-equipamento a {
        text-decoration: none;
        border: 1px solid #6c757d;
        color: #6c757d;
        margin-left: -1px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 42px;
    }
    
    #botoes-equipamento a:hover {
        background-color: #6c757d;
        color: white;
    }
    
    /* Estilos para o modal de equipamentos */
    .selecionar-equipamento {
        transition: all 0.2s ease;
    }
    
    .selecionar-equipamento:hover {
        transform: scale(1.05);
    }
    
    #vincularEquipamentoModal .table-responsive {
        min-height: 200px;
    }
    
    #vincularEquipamentoModal .modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    #vincularEquipamentoModal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    #busca-equipamento {
        border-radius: 8px;
        padding: 10px 15px;
    }
    
    /* Estilo para destacar o campo de equipamento selecionado */
    #equipamento.com-equipamento {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    /* Indicador visual para campos importantes */
    .campo-importante {
        position: relative;
    }
    
    .campo-importante:after {
        content: '✓';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #28a745;
        font-weight: bold;
        display: none;
    }
    
    .campo-importante.preenchido:after {
        display: inline;
    }
</style>
{% endblock %}

{% block content %}
<div id="alerta-cliente" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
    <strong>Atenção!</strong> Por favor, selecione um cliente primeiro!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
  </div>
  
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2"><i class="fas fa-plus-circle me-2"></i> Nova Ordem de Serviço</h1>
        <p class="text-muted">Preencha os campos abaixo para criar uma nova ordem de serviço.</p>
    </div>
    <div>
        <a href="{% url 'listar_ordens' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Voltar
        </a>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show mb-4">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<form method="post" id="nova-ordem-form">
    {% csrf_token %}
    
    <!-- === Seção de Identificação e Cliente (Recriada) === -->
    <div class="form-section fade-in-section shadow-sm">
        <div class="section-header">
            <div class="section-icon cliente-icon"><i class="fas fa-user"></i></div>
            <div>
                <h4 class="mb-0">Identificação e Cliente</h4>
                <p class="text-muted mb-0">Dados básicos e seleção de cliente/equipamento</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-7">
                <div class="mb-4">
                    <label for="cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <select class="form-select" id="cliente" name="cliente" required>
                            <option value="">--- Selecione um cliente ---</option>
                            {% for c in clientes %}
                            <option value="{{ c.id }}">{{ c.nome }} {% if c.cpf_cnpj %}({{ c.cpf_cnpj }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#buscarClienteModal" title="Buscar Cliente">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="buscar-equipamentos-btn" title="Buscar equipamentos do cliente selecionado">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="field-hint">Escolha o cliente para quem o serviço será prestado.</div>
                </div>
            </div>
            
            <div class="col-md-5">
                <div class="mb-4">
                    <label for="equipamento" class="form-label">Equipamento</label>
                        <div class="input-group">
                            <select class="form-select" id="equipamento" name="equipamento">
                                <option value="">Selecione um cliente primeiro</option>
                            </select>
                        <button type="button" class="btn btn-outline-primary" id="vincular-equipamento-btn" onclick="abrirModalEquipamentos()" title="Vincular Equipamento">
                            <i class="fas fa-link"></i>
                            </button>
                        </div>
                        <div class="field-hint">Selecione o equipamento ou clique em "Vincular" para buscar.</div>
                    </div>
                </div>
            </div>
    </div>
    <!-- === Fim da Seção Identificação === -->
    
    <!-- Seção de Serviço e Atendimento (Mantida) -->
    <div class="form-section fade-in-section shadow-sm">
        <div class="section-header"> <div class="section-icon servico-icon"><i class="fas fa-tools"></i></div> <div> <h4 class="mb-0">Serviço Se Atendimento</h4> <p class="text-muted mb-0">Detalhes do serviço</p> </div> </div>
        <div class="row">
            <div class="col-md-6 mb-4">
                    <label for="categoria" class="form-label">Categoria <span class="text-danger">*</span></label>
                    <div class="input-group">
                    <select class="form-select" id="categoria" name="categoria" required> <option value="">Selecione...</option> {% for cat in categorias %} <option value="{{ cat.id }}">{{ cat.nome }}</option> {% endfor %} </select>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#novaCategoriaModal" title="Nova Categoria"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                    <label for="tecnico" class="form-label">Técnico Responsável</label>
                <select class="form-select" id="tecnico" name="tecnico"> <option value="">Selecione...</option> {% for tec in tecnicos %} <option value="{{ tec.id }}">{{ tec.nome_completo }}</option> {% endfor %} </select>
            </div>
        </div>
        <div class="row"> <div class="col-12 mb-3"> <label for="descricao" class="form-label">Descrição do Problema <span class="text-danger">*</span></label> <textarea class="form-control" id="descricao" name="descricao" rows="4" placeholder="Descreva detalhadamente o problema..." required></textarea> </div> </div>
        <div class="row"> <div class="col-12"> <label class="form-label">Prioridade</label> <div class="prioridade-selector"> <div class="prioridade-option prioridade-baixa" data-value="baixa"><i class="fas fa-arrow-down mb-2"></i><div>Baixa</div></div> <div class="prioridade-option prioridade-media selected" data-value="media"><i class="fas fa-minus mb-2"></i><div>Média</div></div> <div class="prioridade-option prioridade-alta" data-value="alta"><i class="fas fa-arrow-up mb-2"></i><div>Alta</div></div> <div class="prioridade-option prioridade-urgente" data-value="urgente"><i class="fas fa-exclamation-triangle mb-2"></i><div>Urgente</div></div> </div> <input type="hidden" name="prioridade" id="prioridade_input" value="media"> </div> </div>
        <div class="row mt-3"> <div class="col-md-4"> <div class="form-floating"> <select class="form-select" id="status" name="status"> <option value="aberta" selected>Aberta</option> <option value="em_andamento">Em Andamento</option> <option value="aguardando_peca">Aguardando Peça</option> <option value="aguardando_cliente">Aguardando Cliente</option> </select> <label for="status">Status Inicial</label> </div> <div class="field-hint">Status inicial <span id="status-badge">Aberta</span></div> </div> </div>
    </div>
    
    <!-- Seção de Localização (Ajustada) -->
    <div class="form-section fade-in-section shadow-sm">
         <div class="section-header"> 
             <div class="section-icon local-icon"><i class="fas fa-map-marker-alt"></i></div> 
             <div> 
                 <h4 class="mb-0">Localização</h4> 
                 <p class="text-muted mb-0">Endereço do atendimento</p> 
             </div> 
         </div>
         <div class="checkbox-toggle mb-3"> 
             <button type="button" class="btn btn-sm btn-outline-primary" id="verificar-endereco-cliente">
                 <i class="fas fa-map-marker-alt me-1"></i> Mesmo endereço do cliente
             </button>
             <div class="field-hint ms-2">(Preenche automaticamente com o endereço do cliente selecionado)</div>
         </div>
         <div id="resultado-verificacao-endereco" class="alert d-none mb-3" style="display:none;"></div>
        
        <!-- Primeira linha: CEP primeiro -->
        <div class="row">
            <div class="col-md-2">
                <label for="cep" class="form-label">CEP</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control localizacao-field" id="cep" name="cep" placeholder="00000-000" maxlength="9">
                    <button class="btn btn-outline-secondary" type="button" id="buscar-cep" title="Buscar endereço" onclick="buscarEnderecoPorCEP()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="spinner-border spinner-border-sm text-primary d-none mt-2" id="cep-loading" role="status">
                    <span class="visually-hidden">Buscando CEP...</span>
                </div>
                <div class="field-hint">Digite o CEP para buscar o endereço</div>
            </div>
            
            <div class="col-md-6"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="endereco" name="endereco" placeholder="Endereço"> 
                    <label for="endereco">Endereço</label> 
                </div> 
            </div>
            <div class="col-md-2"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="numero_endereco" name="numero_endereco" placeholder="Número"> 
                    <label for="numero_endereco">Número</label> 
                </div> 
            </div>
            <div class="col-md-2"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="complemento" name="complemento" placeholder="Complemento"> 
                    <label for="complemento">Complemento</label> 
                </div> 
            </div>
        </div>
        
        <!-- Segunda linha: Bairro, Cidade, Estado -->
        <div class="row mt-3">
            <div class="col-md-4"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="bairro" name="bairro" placeholder="Bairro"> 
                    <label for="bairro">Bairro</label> 
                </div> 
            </div>
            <div class="col-md-6"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="cidade" name="cidade" placeholder="Cidade"> 
                    <label for="cidade">Cidade</label> 
                </div> 
            </div>
            <div class="col-md-2"> 
                <div class="form-floating"> 
                    <input type="text" class="form-control localizacao-field" id="estado" name="estado" placeholder="UF" maxlength="2"> 
                    <label for="estado">Estado</label> 
                </div> 
            </div>
        </div>
    </div>
    
    <!-- Seção de Valores (Mantida) -->
    <div class="form-section fade-in-section shadow-sm">
        <div class="section-header"> <div class="section-icon valores-icon"><i class="fas fa-dollar-sign"></i></div> <div> <h4 class="mb-0">Valores</h4> <p class="text-muted mb-0">Valores previstos</p> </div> </div>
        <div class="row">
            <div class="form-floating">
    <input type="text" class="form-control valor-input" id="valor_servico" name="valor_servico" placeholder="Serviço" value="0,00">
    <label for="valor_servico">Serviço (R$)</label>
</div>
            <div class="col-md-3"> <div class="form-floating"> <input type="text" class="form-control valor-input" id="valor_pecas" name="valor_pecas" placeholder="Peças" step="0.01" min="0" value="0.00"> <label for="valor_pecas">Peças (R$)</label> </div> </div>
            <div class="col-md-3"> <div class="form-floating"> <input type="text" class="form-control valor-input" id="valor_deslocamento" name="valor_deslocamento" placeholder="Deslocamento" step="0.01" min="0" value="0.00"> <label for="valor_deslocamento">Deslocamento (R$)</label> </div> </div>
            <div class="col-md-3"> <div class="form-floating"> <input type="text" class="form-control valor-input" id="desconto" name="desconto" placeholder="Desconto" step="0.01" min="0" value="0.00"> <label for="desconto">Desconto (R$)</label> </div> </div>
        </div>
         {% if request.user.is_superuser %}
<div class="row mt-3">
    <div class="col-md-6 offset-md-6 text-end">
        <div class="bg-light p-3 rounded">
            <h5 class="mb-0">Valor Total: <span class="text-primary" id="valor_total_display">R$ 0,00</span></h5>
        </div>
    </div>
</div>
{% endif %}
         <div class="row mt-3"> <div class="col-12"> <div class="form-floating"> <textarea class="form-control" id="observacoes" name="observacoes" rows="2" placeholder="Observações"></textarea> <label for="observacoes">Observações Internas</label> </div> </div> </div>
    </div>
    
    <!-- Ações do Formulário (Mantidas) -->
    <div class="form-actions">
        <a href="{% url 'listar_ordens' %}" class="btn btn-outline-secondary"><i class="fas fa-times me-2"></i> Cancelar</a>
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary btn-action" id="btn-salvar" name="action" value="save"><i class="fas fa-save me-2"></i> Salvar Ordem</button>
            <button type="submit" class="btn btn-outline-primary btn-action" id="btn-salvar-imprimir" name="action" value="save_and_print"><i class="fas fa-print me-2"></i> Salvar e Imprimir</button>
        </div>
    </div>
    {# Input oculto para salvar e imprimir #}
    <input type="hidden" name="imprimir_apos_salvar" id="imprimir_apos_salvar_input" value="false">
</form>

<!-- Modais (Mantidos por enquanto - AJUSTAR PATHS SE NECESSÁRIO) -->
{# {% include 'modals/buscar_cliente_modal.html' %} #}
{# {% include 'modals/nova_categoria_modal.html' %} #}
{# Incluir outros modais se existirem #}

<!-- Modal de Vincular Equipamento -->
<div class="modal fade" id="vincularEquipamentoModal" tabindex="-1" aria-labelledby="vincularEquipamentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vincularEquipamentoModalLabel">Vincular Equipamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="busca-equipamento" placeholder="Buscar equipamento por nome ou código...">
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Total: <span id="total-equipamentos">0</span> equipamentos encontrados</span>
                    <a href="{% url 'novo_equipamento' %}?cliente_id=" class="btn btn-success btn-sm" id="novo-equipamento-link">
                        <i class="fas fa-plus me-1"></i> Novo Equipamento
                    </a>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Modelo</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-equipamentos">
                            <tr>
                                <td colspan="5" class="text-center">Selecione um cliente para ver equipamentos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex mt-2">
                    <a href="{% url 'listar_equipamentos' %}" class="btn btn-outline-info w-100">
                        <i class="fas fa-cogs me-1"></i> Ver Todos os Equipamentos
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'listar_equipamentos' %}" class="btn btn-primary">
                    <i class="fas fa-cogs me-1"></i> Gerenciar Equipamentos
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Nova Categoria -->
<div class="modal fade" id="novaCategoriaModal" tabindex="-1" aria-labelledby="novaCategoriaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novaCategoriaModalLabel"><i class="fas fa-tag me-2"></i> Nova Categoria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNovaCategoria" method="post" action="{% url 'criar_categoria_ajax' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nome_categoria" class="form-label">Nome da Categoria <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome_categoria" name="nome" required>
                        <div class="form-text">Digite um nome descritivo para a categoria (Ex: Manutenção Preventiva, Instalação, etc).</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao_categoria" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao_categoria" name="descricao" rows="3"></textarea>
                        <div class="form-text">Uma breve descrição dos serviços incluídos nesta categoria.</div>
                    </div>
                    
                    <div id="categoria_alert" class="alert d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvar_categoria">Salvar Categoria</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<!-- Pode estar causando conflito se estiver sendo carregado duas vezes -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> -->
 <input type="text" id="valor" oninput="formatarValor(this)">

<script>
// Funções globais - definidas fora do $(document).ready



// Script dedicado para o modal Nova Categoria - usando JavaScript puro para evitar conflitos
document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando script para o modal Nova Categoria...");
    
    // Obter referência ao botão de salvar categoria
    const btnSalvarCategoria = document.getElementById('salvar_categoria');
    
    if (btnSalvarCategoria) {
        console.log("Botão 'Salvar Categoria' encontrado, adicionando event listener...");
        
        // Adicionar listener de clique diretamente (sem jQuery)
        btnSalvarCategoria.addEventListener('click', function(event) {
            event.preventDefault();
            console.log("Botão 'Salvar Categoria' clicado!");
            
            // Obter os dados do formulário
            const form = document.getElementById('formNovaCategoria');
            const nomeInput = document.getElementById('nome_categoria');
            const descricaoInput = document.getElementById('descricao_categoria');
            const alertDiv = document.getElementById('categoria_alert');
            
            const nome = nomeInput.value.trim();
            const descricao = descricaoInput.value.trim();
            
            // Validação básica
            if (!nome) {
                alertDiv.textContent = 'O nome da categoria é obrigatório.';
                alertDiv.className = 'alert alert-danger';
                alertDiv.classList.remove('d-none');
                return;
            }
            
            // Mostar indicação visual de processamento
            btnSalvarCategoria.disabled = true;
            btnSalvarCategoria.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
            
            // Preparar dados para envio
            const formData = new FormData(form);
            
            // Enviar dados usando fetch (API moderna, sem jQuery)
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Resposta do servidor:', data);
                
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alertDiv.textContent = data.message;
                    alertDiv.className = 'alert alert-success';
                    alertDiv.classList.remove('d-none');
                    
                    // Adicionar a categoria ao select
                    const categoriaSelect = document.getElementById('categoria');
                    if (categoriaSelect) {
                        const option = document.createElement('option');
                        option.value = data.categoria_id;
                        option.text = nome
                        option.selected = true;
                        categoriaSelect.appendChild(option);
                    }
                    
                    // Limpar os campos
                    nomeInput.value = '';
                    descricaoInput.value = '';
                    
                    // Fechar o modal após um breve delay
                    setTimeout(function() {
                        const modal = document.getElementById('novaCategoriaModal');
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        
                        if (bsModal) {
                            bsModal.hide();
                        } else {
                            // Fallback manual se a instância não estiver disponível
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) backdrop.remove();
                            modal.classList.remove('show');
                            modal.style.display = 'none';
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                        }
                        
                        // Mostrar mensagem de sucesso
                    }, 1000);
                } else {
                    // Mostrar mensagem de erro
                    alertDiv.textContent = data.message || 'Ocorreu um erro ao criar a categoria.';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alertDiv.textContent = 'Ocorreu um erro na comunicação com o servidor.';
                alertDiv.className = 'alert alert-danger';
                alertDiv.classList.remove('d-none');
            })
            .finally(() => {
                // Restaurar o botão ao estado original
                btnSalvarCategoria.disabled = False;
                btnSalvarCategoria.innerHTML = 'Salvar Categoria';
            });
        });
        
    } else {
        console.error("ERRO: Botão 'Salvar Categoria' não encontrado no DOM!");
    }
});

// Garantir que o DOM esteja carregado antes de registrar os eventos
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM totalmente carregado - Registrando eventos");
    
    // Registrar evento para o botão de verificar endereço
    const verificarEnderecoBtn = document.getElementById('verificar-endereco-cliente');
    if (verificarEnderecoBtn) {
        console.log("Botão de verificar endereço encontrado, registrando evento");
        verificarEnderecoBtn.addEventListener('click', function() {
            console.log("Botão Verificar Endereço clicado!");
            const clienteId = document.getElementById('cliente').value;
            const resultadoDiv = document.getElementById('resultado-verificacao-endereco');
            
            if (!clienteId) {
                console.log("Nenhum cliente selecionado");
                resultadoDiv.className = 'alert alert-warning mb-3';
                resultadoDiv.innerHTML = '<strong>Atenção:</strong> Selecione um cliente primeiro.';
                resultadoDiv.classList.remove('d-none');
                resultadoDiv.style.display = 'block';
                return;
            }
            
            // Mostrar loading
            console.log("Cliente selecionado:", clienteId);
            resultadoDiv.className = 'alert alert-info mb-3';
            resultadoDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Verificando endereço do cliente...';
            resultadoDiv.classList.remove('d-none');
            resultadoDiv.style.display = 'block';
            
            // Buscar endereço
            fetch("{% url 'buscar_endereco_cliente' %}?cliente_id=" + clienteId)
                .then(response => response.json())
                .then(data => {
                    console.log("Dados de verificação recebidos:", data);
                    
                    if (data.success) {
                        // Aplicar automaticamente o endereço aos campos
                        document.getElementById('endereco').value = data.endereco || '';
                        document.getElementById('numero_endereco').value = data.numero || '';
                        document.getElementById('complemento').value = data.complemento || '';
                        document.getElementById('bairro').value = data.bairro || '';
                        document.getElementById('cidade').value = data.cidade || '';
                        document.getElementById('estado').value = data.estado || '';
                        document.getElementById('cep').value = data.cep || '';
                        
                        // Destacar campos com fundo verde temporariamente
                        document.querySelectorAll('.localizacao-field').forEach(field => {
                            field.classList.add('auto-filled');
                            setTimeout(() => field.classList.remove('auto-filled'), 2000);
                        });
                        
                        // Mostrar mensagem de sucesso com opção de desfazer
                        resultadoDiv.className = 'alert alert-success mb-3';
                        resultadoDiv.innerHTML = `
                            <strong>Endereço do cliente aplicado com sucesso!</strong><br>
                            <div class="mt-2">
                                <small class="text-muted">
                                    ${data.endereco || '-'}, ${data.numero || '-'}
                                    ${data.complemento ? ', ' + data.complemento : ''}
                                    - ${data.bairro || '-'}, ${data.cidade || '-'}/${data.estado || '-'}
                                    ${data.cep ? ' - CEP: ' + data.cep : ''}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" id="desfazer-endereco">
                                <i class="fas fa-undo me-1"></i> Desfazer
                            </button>
                        `;
                        
                        // Adicionar listener para o botão "Desfazer"
                        document.getElementById('desfazer-endereco').addEventListener('click', function() {
                            limparCamposEndereco();
                            resultadoDiv.classList.add('d-none');
                            resultadoDiv.style.display = 'none';
                        });
                    } else {
                        resultadoDiv.className = 'alert alert-danger mb-3';
                        resultadoDiv.innerHTML = `<strong>Erro:</strong> ${data.message}`;
                    }
                })
                .catch(error => {
                    console.error("Erro ao verificar endereço:", error);
                    resultadoDiv.className = 'alert alert-danger mb-3';
                    resultadoDiv.innerHTML = `<strong>Erro:</strong> Falha ao comunicar com o servidor. ${error}`;
                });
        });
    } else {
        console.error("Botão de verificar endereço não encontrado no DOM!");
    }
});
document.addEventListener('DOMContentLoaded', function() {
    const camposMoeda = [
        document.getElementById('valor_servico'),
        document.getElementById('valor_pecas'),
        document.getElementById('valor_deslocamento'),
        document.getElementById('desconto')
    ];
    camposMoeda.forEach(function(campo) {
        campo.addEventListener('input', function() {
            formatarMoeda(this);
        });
        // Se já tiver valor, formata ao carregar
        if (campo.value && !campo.value.startsWith('R$')) {
            formatarMoeda(campo);
        }
    });

    // Ao enviar o formulário, remove a máscara para enviar só o número
    document.getElementById('nova-ordem-form').addEventListener('submit', function() {
        camposMoeda.forEach(function(campo) {
            campo.value = limparMascaraMoeda(campo.value);
        });
    });
});
// ...localize a função abrirModalEquipamentos() e substitua por:

function abrirModalEquipamentos() {
    const clienteId = document.getElementById('cliente').value;
    const alerta = document.getElementById('alerta-cliente');

    if (!clienteId) {
        alerta.classList.remove('d-none'); // Mostra o alerta
        return;
    }

    alerta.classList.add('d-none'); // Esconde o alerta se cliente selecionado

    // Obter o nome do cliente
    const clienteSelect = document.getElementById('cliente');
    const clienteNome = clienteSelect.options[clienteSelect.selectedIndex].text;

    // Atualizar o título do modal
    document.getElementById('vincularEquipamentoModalLabel').textContent =
        'Equipamentos de ' + clienteNome;

    // Exibir mensagem de carregamento
    document.getElementById('lista-equipamentos').innerHTML = `
        <tr>
            <td colspan="5" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Carregando equipamentos...</p>
            </td>
        </tr>
    `;

    // Exibir o modal
    const modalElement = document.getElementById('vincularEquipamentoModal');
    const modalObj = new bootstrap.Modal(modalElement);
    modalObj.show();

    // Buscar equipamentos
    fetch("{% url 'buscar_equipamentos_cliente' %}?cliente_id=" + clienteId)
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            const lista = document.getElementById('lista-equipamentos');
            const totalSpan = document.getElementById('total-equipamentos');
            lista.innerHTML = '';
            if (data.equipamentos && data.equipamentos.length > 0) {
                totalSpan.textContent = data.equipamentos.length;
                data.equipamentos.forEach(eq => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-codigo', eq.codigo || '');
                    tr.setAttribute('data-nome', eq.nome || '');
                    tr.innerHTML = `
                        <td>${eq.codigo || 'S/C'}</td>
                        <td>${eq.nome}</td>
                        <td>${eq.modelo || ''}</td>
                        <td>${eq.status || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-success selecionar-equipamento" onclick="selecionarEquipamento('${eq.id}', '${eq.nome.replace(/'/g, "\\'")}', '${eq.codigo || ''}')">
                                <i class="fas fa-check"></i> Selecionar
                            </button>
                        </td>
                    `;
                    lista.appendChild(tr);
                });
            } else {
                totalSpan.textContent = 0;
                lista.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">Nenhum equipamento encontrado para este cliente.</td>
                    </tr>
                `;
            }
            // Atualiza o link de novo equipamento para já trazer o cliente selecionado
            document.getElementById('novo-equipamento-link').href = "{% url 'novo_equipamento' %}?cliente_id=" + clienteId;
        })
        .catch(function(error) {
            document.getElementById('lista-equipamentos').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">Erro ao carregar equipamentos.</td>
                </tr>
            `;
            document.getElementById('total-equipamentos').textContent = 0;
        });
}
function selecionarEquipamento(id, nome, codigo) {
    console.log("Selecionando equipamento:", id, nome, codigo);
    
    // Atualizar o select
    const equipamentoSelect = document.getElementById('equipamento');
    equipamentoSelect.innerHTML = '';
    
    const option = document.createElement('option');
    option.value = id;
    option.text = codigo + ' - ' + nome;
    option.selected = true;
    equipamentoSelect.appendChild(option);
    
    // Garantir que o select não esteja desabilitado
    equipamentoSelect.disabled = false;
    
    // Adicionar classe visual para destacar que há equipamento selecionado
    equipamentoSelect.classList.add('com-equipamento');
    equipamentoSelect.parentNode.classList.add('campo-importante', 'preenchido');
    
    // Fechar o modal
    const modalElement = document.getElementById('vincularEquipamentoModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    modalInstance.hide();
    
    // Mostrar mensagem de sucesso
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
    alertDiv.setAttribute('role', 'alert');
    alertDiv.innerHTML = `
        Equipamento "${nome}" vinculado com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    `;
    
    equipamentoSelect.parentNode.parentNode.appendChild(alertDiv);
    
    // Remover alerta após 3 segundos
    setTimeout(function() {
        alertDiv.remove();
    }, 3000);
}

// Função helper para fechar modais com segurança
function fecharModalComSeguranca(modalId) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DEBUG: Document Ready - Iniciando script extra_js.");

    const clienteSelect = $('#cliente');
    const equipamentoSelect = $('#equipamento');
    const buscarEquipBtn = $('#buscar-equipamentos-btn');
    const vincularEquipBtn = $('#vincular-equipamento-btn');
    const listaEquipamentos = $('#lista-equipamentos');
    const buscaEquipamento = $('#busca-equipamento');

    console.log("DEBUG: Elemento clienteSelect:", clienteSelect);
    if (!clienteSelect.length) {
        console.error("ERRO: Elemento #cliente não encontrado!");
    }

    // Inicialização quando o documento carrega
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Inicializando script...");
        
        // Variável para armazenar o último endereço do cliente carregado
        let ultimoEnderecoCliente = null;
        
        // Função para buscar o endereço do cliente selecionado
        function buscarEnderecoCliente(clienteId) {
            if (!clienteId) return;
            
            // Mostrar indicador de carregamento nos campos de endereço
            document.getElementById('endereco').classList.add('loading-data');
            
            fetch("{% url 'buscar_endereco_cliente' %}?cliente_id=" + clienteId)
                .then(response => response.json())
                .then(data => {
                    // Remover indicador de carregamento
                    document.getElementById('endereco').classList.remove('loading-data');
                    
                    console.log("Resposta completa da API:", data);
                    
                    if (data.success) {
                        // Armazenar os dados de endereço para uso posterior
                        ultimoEnderecoCliente = data;
                        console.log("Endereço do cliente carregado com sucesso:", data);
                        
                        // Se o checkbox estiver marcado, preencher os campos de endereço
                        const checkboxMesmoEndereco = document.getElementById('mesmo_endereco_cliente');
                        if (checkboxMesmoEndereco.checked) {
                            preencherEnderecoCliente(data);
                        }
                    } else {
                        console.error("Erro ao buscar endereço do cliente:", data.message);
                        
                        // Tentar alternativa: buscar diretamente da página de detalhes do cliente
                        console.log("Tentando buscar endereço da página de detalhes do cliente");
                        buscarEnderecoClienteAlternativo(clienteId);
                    }
                })
                .catch(error => {
                    // Remover indicador de carregamento em caso de erro
                    document.getElementById('endereco').classList.remove('loading-data');
                    console.error("Erro na requisição de endereço:", error);
                    
                    // Tentar alternativa em caso de falha
                    buscarEnderecoClienteAlternativo(clienteId);
                });
        }
        
        // Função alternativa para buscar o endereço do cliente de forma simplificada
        function buscarEnderecoClienteAlternativo(clienteId) {
            if (!clienteId) return;
            
            console.log("Tentando método alternativo para buscar endereço do cliente:", clienteId);
            
            // Usar diretamente a API correta
            fetch("{% url 'buscar_endereco_cliente' %}?cliente_id=" + clienteId)
                .then(response => response.json())
                .then(data => {
                    console.log("Resposta da API de endereço:", data);
                    
                    if (data.success) {
                        // Armazenar os dados de endereço
                        ultimoEnderecoCliente = data;
                        
                        // Verificar checkbox e preencher
                        const checkboxMesmoEndereco = document.getElementById('mesmo_endereco_cliente');
                        if (checkboxMesmoEndereco && checkboxMesmoEndereco.checked) {
                            preencherEnderecoCliente(data);
                        }
                    } else {
                        console.error("Erro na resposta da API:", data.message);
                        alert("Não foi possível carregar o endereço do cliente. Por favor, insira manualmente.");
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar endereço do cliente:", error);
                    alert("Não foi possível carregar o endereço do cliente. Por favor, insira manualmente.");
                });
        }
        
        // Função para preencher os campos de endereço com os dados do cliente
        function preencherEnderecoCliente(endereco) {
            if (!endereco) return;
            
            console.log("Tentando preencher com dados:", endereco);
            
            // Múltiplas tentativas de acessar os dados de endereço
            // dependendo de como a API está estruturada
            let enderecoValor = '';
            let numeroValor = '';
            let complementoValor = '';
            let bairroValor = '';
            let cidadeValor = '';
            let estadoValor = '';
            let cepValor = '';
            
            // Tentativa 1: dados diretos no objeto principal
            if (endereco.endereco) {
                enderecoValor = endereco.endereco;
                numeroValor = endereco.numero || '';
                complementoValor = endereco.complemento || '';
                bairroValor = endereco.bairro || '';
                cidadeValor = endereco.cidade || '';
                estadoValor = endereco.estado || '';
                cepValor = endereco.cep || '';
                console.log("Usando dados do objeto principal");
            } 
            // Tentativa 2: dados em uma propriedade aninhada
            else if (endereco.cliente && endereco.cliente.endereco) {
                enderecoValor = endereco.cliente.endereco;
                numeroValor = endereco.cliente.numero || '';
                complementoValor = endereco.cliente.complemento || '';
                bairroValor = endereco.cliente.bairro || '';
                cidadeValor = endereco.cliente.cidade || '';
                estadoValor = endereco.cliente.estado || '';
                cepValor = endereco.cliente.cep || '';
                console.log("Usando dados do objeto cliente aninhado");
            }
            // Tentativa 3: estrutura de objeto diferente
            else if (typeof endereco === 'object') {
                // Procurar por propriedades que contenham a palavra "endereco"
                for (const key in endereco) {
                    if (key.toLowerCase().includes('endereco') || key.toLowerCase() === 'logradouro') {
                        enderecoValor = endereco[key];
                        console.log("Encontrado endereço na propriedade:", key);
                    }
                    else if (key.toLowerCase().includes('numero')) {
                        numeroValor = endereco[key];
                    }
                    else if (key.toLowerCase().includes('complemento')) {
                        complementoValor = endereco[key];
                    }
                    else if (key.toLowerCase().includes('bairro')) {
                        bairroValor = endereco[key];
                    }
                    else if (key.toLowerCase().includes('cidade')) {
                        cidadeValor = endereco[key];
                    }
                    else if (key.toLowerCase() === 'uf' || key.toLowerCase().includes('estado')) {
                        estadoValor = endereco[key];
                    }
                    else if (key.toLowerCase().includes('cep')) {
                        cepValor = endereco[key];
                    }
                }
                console.log("Buscando propriedades por nome");
            }
            
            // Definir os valores nos campos apenas se houver endereço
            if (enderecoValor) {
                document.getElementById('endereco').value = enderecoValor;
                document.getElementById('numero_endereco').value = numeroValor;
                document.getElementById('complemento').value = complementoValor;
                document.getElementById('bairro').value = bairroValor;
                document.getElementById('cidade').value = cidadeValor;
                document.getElementById('estado').value = estadoValor;
                document.getElementById('cep').value = cepValor;
                
                // Debug values
                console.log("Valores preenchidos:");
                console.log("Endereço:", document.getElementById('endereco').value);
                console.log("Número:", document.getElementById('numero_endereco').value);
                console.log("Complemento:", document.getElementById('complemento').value);
                console.log("Bairro:", document.getElementById('bairro').value);
                console.log("Cidade:", document.getElementById('cidade').value);
                console.log("Estado:", document.getElementById('estado').value);
                console.log("CEP:", document.getElementById('cep').value);
                
                // Adicionar classe visual para indicar campos preenchidos automaticamente
                document.querySelectorAll('.localizacao-field').forEach(field => {
                    field.classList.add('auto-filled');
                    
                    // Animar brevemente para chamar atenção
                    setTimeout(() => field.classList.remove('auto-filled'), 2000);
                });
                
                console.log("Campos de endereço preenchidos com sucesso");
            } else {
                console.warn("Dados de endereço incompletos ou inválidos:", endereco);
                alert("O cliente selecionado não possui endereço cadastrado completo. Por favor, verifique os dados do cliente.");
            }
        }
        
        // Função para limpar os campos de endereço
        function limparCamposEndereco() {
            document.getElementById('endereco').value = '';
            document.getElementById('numero_endereco').value = '';
            document.getElementById('complemento').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('estado').value = '';
            document.getElementById('cep').value = '';
        }
        
        // Evento para o checkbox de mesmo endereço do cliente
        document.getElementById('mesmo_endereco_cliente').addEventListener('change', function() {
            const clienteId = document.getElementById('cliente').value;
            
            if (this.checked) {
                if (clienteId) {
                    // Mostrar feedback para o usuário que estamos buscando o endereço
                    const mensagemCarregamento = document.createElement('div');
                    mensagemCarregamento.id = 'msg-carregamento-endereco';
                    mensagemCarregamento.className = 'alert alert-info mt-2 mb-3';
                    mensagemCarregamento.innerHTML = 'Carregando endereço do cliente...';
                    
                    // Inserir antes dos campos de endereço
                    const campoEndereco = document.getElementById('endereco').closest('.row');
                    campoEndereco.parentNode.insertBefore(mensagemCarregamento, campoEndereco);
                    
                    // Forçar nova busca do endereço do cliente
                    ultimoEnderecoCliente = null;
                    console.log("Buscando endereço do cliente ID:", clienteId);
                    fetch("{% url 'buscar_endereco_cliente' %}?cliente_id=" + clienteId)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Dados de endereço recebidos:", data);
                            if (data.success) {
                                // Armazenar os dados
                                ultimoEnderecoCliente = data;
                                
                                // Preencher os campos imediatamente se a checkbox ainda estiver marcada
                                if (document.getElementById('mesmo_endereco_cliente').checked) {
                                    document.getElementById('endereco').value = data.endereco || '';
                                    document.getElementById('numero_endereco').value = data.numero || '';
                                    document.getElementById('complemento').value = data.complemento || '';
                                    document.getElementById('bairro').value = data.bairro || '';
                                    document.getElementById('cidade').value = data.cidade || '';
                                    document.getElementById('estado').value = data.estado || '';
                                    document.getElementById('cep').value = data.cep || '';
                                    
                                    // Destacar campos com fundo verde temporariamente
                                    document.querySelectorAll('.localizacao-field').forEach(field => {
                                        field.classList.add('auto-filled');
                                        setTimeout(() => field.classList.remove('auto-filled'), 2000);
                                    });
                                }
                            } else {
                                console.error("Erro ao buscar endereço:", data.message);
                                alert("Não foi possível obter o endereço do cliente. Por favor, insira manualmente.");
                            }
                            
                            // Remover mensagem de carregamento
                            const mensagem = document.getElementById('msg-carregamento-endereco');
                            if (mensagem) mensagem.remove();
                        })
                        .catch(error => {
                            console.error("Erro na requisição:", error);
                            const mensagem = document.getElementById('msg-carregamento-endereco');
                            if (mensagem) mensagem.remove();
                            alert("Erro ao buscar o endereço do cliente. Por favor, insira manualmente.");
                        });
                } else {
                    // Se não tem cliente selecionado
                    alert('Por favor, selecione um cliente primeiro antes de usar seu endereço!');
                    this.checked = false;
                }
            } else {
                // Se o checkbox foi desmarcado, limpar os campos
                limparCamposEndereco();
                console.log("Campos de endereço limpos");
            }
        });
        
        // Carregar equipamentos quando o cliente muda
        document.getElementById('cliente').addEventListener('change', function() {
            console.log("Cliente alterado para:", this.value);
            
            const clienteId = this.value;
            const equipamentoSelect = document.getElementById('equipamento');
            
            // Limpar cache de endereço quando o cliente muda
            ultimoEnderecoCliente = null;
            
            // Limpar qualquer mensagem de endereço aplicado
            const resultadoDiv = document.getElementById('resultado-verificacao-endereco');
            resultadoDiv.classList.add('d-none');
            resultadoDiv.style.display = 'none';
            
            if (!clienteId) {
                equipamentoSelect.disabled = true;
                equipamentoSelect.innerHTML = '<option value="">Selecione um cliente primeiro</option>';
                return;
            }
            
            // Exibir "carregando" no select
            equipamentoSelect.innerHTML = '<option value="">Carregando equipamentos...</option>';
            
            // Buscar equipamentos
            fetch("{% url 'buscar_equipamentos_cliente' %}?cliente_id=" + clienteId)
                .then(response => response.json())
                .then(data => {
                    equipamentoSelect.innerHTML = '';
                    
                    if (data.equipamentos && data.equipamentos.length > 0) {
                        equipamentoSelect.innerHTML = '<option value="">--- Selecione um equipamento ---</option>';
                        
                        data.equipamentos.forEach(eq => {
                            const option = document.createElement('option');
                            option.value = eq.id;
                            option.textContent = `${eq.codigo || 'S/C'} - ${eq.nome}`;
                            equipamentoSelect.appendChild(option);
                        });
                        
                        // Habilitar o select se tiver equipamentos
                        equipamentoSelect.disabled = false;
                    } else {
                        equipamentoSelect.innerHTML = '<option value="">Nenhum equipamento encontrado</option>';
                        // Não desabilitar - usuário pode querer usar o botão vincular
                        equipamentoSelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar equipamentos:", error);
                    equipamentoSelect.innerHTML = '<option value="">Erro ao carregar equipamentos</option>';
                    equipamentoSelect.disabled = false;
                });
        });
        
        // Configurar busca no modal
        document.getElementById('busca-equipamento').addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const linhasEquipamentos = document.querySelectorAll('#lista-equipamentos tr');
            
            linhasEquipamentos.forEach(function(row) {
                // Pular linha de mensagem
                if (row.querySelector('td[colspan="5"]')) return;
                
                const codigo = row.getAttribute('data-codigo').toLowerCase();
                const nome = row.getAttribute('data-nome').toLowerCase();
                
                if (codigo.includes(termo) || nome.includes(termo)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Configurar seleção de prioridade
        const prioridadeOptions = document.querySelectorAll('.prioridade-option');
        prioridadeOptions.forEach(function(option) {
            option.addEventListener('click', function() {
                prioridadeOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('prioridade_input').value = this.getAttribute('data-value');
            });
        });
        
        // Configurar cálculo de valores
        const valorInputs = document.querySelectorAll('.valor-input');
        function atualizarTotal() {
            let total = 0;
            total += parseFloat(document.getElementById('valor_servico').value) || 0;
            total += parseFloat(document.getElementById('valor_pecas').value) || 0;
            total += parseFloat(document.getElementById('valor_deslocamento').value) || 0;
            total -= parseFloat(document.getElementById('desconto').value) || 0;
            
            document.getElementById('valor_total_display').textContent = 
                `R$ ${total.toFixed(2).replace('.', ',')}`;
        }
        
        valorInputs.forEach(input => {
            input.addEventListener('input', atualizarTotal);
        });
        
        // Iniciar com valor total calculado
        atualizarTotal();
        
        // Capturar submissão do formulário para definir o valor de imprimir_apos_salvar
        document.getElementById('nova-ordem-form').addEventListener('submit', function(e) {
            // Verificar se existe um campo de equipamento para habilitá-lo
            const equipamentoSelect = document.getElementById('equipamento');
            if (equipamentoSelect) {
                equipamentoSelect.disabled = false;
                
                // Log para verificar o equipamento selecionado
                console.log("Formulário enviado com equipamento ID:", equipamentoSelect.value);
            }
            
            // Verificar qual botão foi clicado
            const submitter = e.submitter;
            if (submitter && submitter.value === 'save_and_print') {
                document.getElementById('imprimir_apos_salvar_input').value = 'true';
                console.log('Formulário sendo enviado para impressão:', document.getElementById('imprimir_apos_salvar_input').value);
            } else {
                document.getElementById('imprimir_apos_salvar_input').value = 'false';
                console.log('Formulário sendo enviado sem impressão:', document.getElementById('imprimir_apos_salvar_input').value);
            }
            
            // Verificar se o cliente foi selecionado
            const clienteId = document.getElementById('cliente').value;
            if (!clienteId) {
                alert('Por favor, selecione um cliente antes de prosseguir.');
                e.preventDefault();
                return false;
            }
            
            // Log de informações adicionais
            console.log("Formulário enviado com cliente ID:", clienteId);
        });
        
        console.log("Script inicializado com sucesso!");
    });

    // Adicionar evento de clique para o botão buscar-equipamentos-btn
    buscarEquipBtn.on('click', function() {
        abrirModalEquipamentos();
    });

    // Adicionar um evento ao formulário para garantir que o equipamento esteja habilitado
    document.getElementById('nova-ordem-form').addEventListener('submit', function(e) {
        // Garantir que o campo de equipamento não esteja desabilitado ao enviar
        const equipamentoSelect = document.getElementById('equipamento');
        equipamentoSelect.disabled = false;
        
        // Log de informações
        console.log("Formulário enviado com cliente ID:", document.getElementById('cliente').value);
        console.log("Formulário enviado com equipamento ID:", equipamentoSelect.value);
    });

    // Adicionar listener para o select de equipamento
    document.getElementById('equipamento').addEventListener('change', function() {
        if (this.value) {
            this.classList.add('com-equipamento');
            this.parentNode.classList.add('campo-importante', 'preenchido');
        } else {
            this.classList.remove('com-equipamento');
            this.parentNode.classList.remove('preenchido');
        }
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      const prioridadeOptions = document.querySelectorAll('.prioridade-option');
      const prioridadeInput = document.getElementById('prioridade_input');
  
      prioridadeOptions.forEach(option => {
        option.addEventListener('click', () => {
          // Remove classe "selected" de todas
          prioridadeOptions.forEach(opt => opt.classList.remove('selected'));
  
          // Adiciona "selected" à clicada
          option.classList.add('selected');
  
          // Atualiza o input hidden
          const valor = option.getAttribute('data-value');
          prioridadeInput.value = valor;
          console.log('Prioridade definida para:', valor);
        });
      });
    });
    function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, '');
    valor = (parseInt(valor, 10) / 100).toFixed(2) + '';
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    input.value = 'R$ ' + valor;
}

// Remove a máscara para pegar o valor puro ao enviar o formulário
function limparMascaraMoeda(valor) {
    return valor.replace(/\D/g, '') / 100;
}

// Função para buscar CEP
function buscarEnderecoPorCEP() {
    console.log('Iniciando busca de CEP...');
    
    const cepInput = document.getElementById('cep');
    if (!cepInput) {
        console.error('Campo de CEP não encontrado!');
        return;
    }
    
    const cep = cepInput.value.replace(/\D/g, '');
    console.log('CEP a ser buscado:', cep);
    
    if (cep.length !== 8) {
        alert('CEP deve conter 8 dígitos.');
        return;
    }
    
    // Mostrar spinner
    const cepLoading = document.getElementById('cep-loading');
    if (cepLoading) {
        cepLoading.classList.remove('d-none');
    }
    
    // Fazer requisição para a API ViaCEP
    console.log(`Buscando CEP na API: https://viacep.com.br/ws/${cep}/json/`);
    
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao buscar CEP');
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos da API:', data);
            
            if (data.erro) {
                alert('CEP não encontrado.');
                return;
            }
            
            // Preencher os campos
            if (data.logradouro) document.getElementById('endereco').value = data.logradouro;
            if (data.bairro) document.getElementById('bairro').value = data.bairro;
            if (data.localidade) document.getElementById('cidade').value = data.localidade;
            if (data.uf) document.getElementById('estado').value = data.uf;
            
            // Adicionar classe visual para indicar preenchimento automático
            const campos = ['endereco', 'bairro', 'cidade', 'estado'];
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento && elemento.value) {
                    elemento.classList.add('auto-filled');
                    setTimeout(() => {
                        elemento.classList.remove('auto-filled');
                    }, 3000);
                }
            });
            
            console.log('Endereço preenchido automaticamente');
        })
        .catch(error => {
            console.error('Erro na busca de CEP:', error);
            alert('Erro ao buscar o CEP. Tente novamente.');
        })
        .finally(() => {
            // Esconder spinner
            if (cepLoading) {
                cepLoading.classList.add('d-none');
            }
        });
}

// Configurar eventos do CEP quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar máscara de CEP
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        // Máscara de CEP: 00000-000
        cepInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            valor = valor.replace(/^(\d{5})(\d)/, '$1-$2');
            e.target.value = valor;
        });
        
        // Buscar CEP quando pressionar Enter
        cepInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarEnderecoPorCEP();
            }
        });
        
        // Buscar CEP ao sair do campo (blur)
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                buscarEnderecoPorCEP();
            }
        });
    }
    
    // Configurar botão de busca de CEP
    const buscarCepBtn = document.getElementById('buscar-cep');
    if (buscarCepBtn) {
        buscarCepBtn.addEventListener('click', function(e) {
            e.preventDefault();
            buscarEnderecoPorCEP();
        });
    }
});
</script>
{% endblock %} 